<head>
  <script src="https://cdn.jsdelivr.net/gh/tuftsceeo/SPIKE-Web-Interface/cdn/ServiceDock.js" charset="utf-8"></script>
  <script src="airtable_script.js" charset="utf-8"></script>
  <link rel="stylesheet" href="style.css" />
  <script language="JavaScript">

    // overwrite the timer value:
    timeout_timer_val = 750; // check faster

    function update_motor_num(elem) {
      new_motor_num = elem.value;
      document.getElementById("name_val").value = "motor" + new_motor_num.toString();
      console.log("Updated field (name_val) to be: " + document.getElementById("name_val").value);
      return false;
    }

    function SPIKE_move_motor(name_val, value_val) {
        motor_port = document.getElementById("motor_port").value;
				if (my_SPIKE.isActive()) {
          my_SPIKE.PrimeHub().light_matrix.off();
					// look up the current value stored in Airtable
					motor_speed = parseInt(my_airtable.getValue(vals["name_val"]));
          motor_speed = Math.max(Math.min(motor_speed, 100), -100); // make sure in range -100 to 100
					my_SPIKE.Motor(motor_port).start(motor_speed);
          document.getElementById("motor_speed_from_airtable").value = motor_speed;
          var timeout = 250;
          if (motor_speed < 0) {
            setTimeout(function() {
              console.log("set timeout: write <");
              my_SPIKE.PrimeHub().light_matrix.write('<');
            }, timeout);
          } else if (motor_speed == 0) {
            setTimeout(function() {
              console.log("set timeout: write X");
              my_SPIKE.PrimeHub().light_matrix.write('X');
            }, timeout);
          } else {
            // motor speed > 0
            setTimeout(function() {
              console.log("set timeout: write >");
              my_SPIKE.PrimeHub().light_matrix.write('>');
            }, timeout);
          }
				} else {
					init_spike_error("in SPIKE_move_motor");
				}
    }
  </script>
</head>
<body type=local>

  <h1>Robot Control</h1>

  <p style="color: red"><b><em>NOTE:</em> This code is for controlling the robot.  It's run locally and interacts with the robot via Serial.</b></p>

  <p>
    Unless you know what you are doing, you probably are supposed to be here:
    <a href="MotorControl.html">Return to the main Motor Control Page</a>
  </p>

  <hr>

  <div style="border: 1px solid; padding: 2px; background-color: rgba(255,255,153,0.8)">
    <div id="servicedock" style="float:right; padding: 10px;">
      <!-- AIRTABLE SERVICE -->
      <service-airtable id="service_airtable" apikey = "" baseid = "" tablename = ""></service-airtable>
      <!-- SPIKE Prime Service -->
      <service-spike id="service_spike"></service-spike>
    </div>
  <p>
    <b>To use the SPIKE™ Prime hardware,</b> you must enable the WebSerial API in your browser. To do so, please make sure:
    <ul>
        <li>You are using the Google Chrome browser.</li>
        <li>The following chrome flags are enabled on <b>chrome://flags</b>.</li>
        <ul>
          <li>Mac OSX user? <em>#enable-experimental-web-platform-features</em></li>
          <li>Windows user? <em>#enable-experimental-web-platform-features</em> <b>AND</b> <em>#new-usb-backend</em></li>
        </ul>
    </ul>

    <b>To enable these flags:</b>
    <ol>
        <li>In your Browser URL, visit <b>chrome://flags</b></li>
        <li>Set the your required flags to "Enabled" via dropdown</li>
        <li>Relaunch the browser to have changes take effect</li>
        <li>Revisit this page and activate the SPIKE™ Prime Service Dock (top right)</li>
    </ol>
  </p></div>

  <h2>Controls:</h2>

  <p><a href="https://docs.google.com/presentation/d/1mJocURYhKTREILhA1RT9PZfyO_GbQvhapKy_znGw2YA/edit?usp=sharing">Robot Build Instructions</a></p>

  <div style="border: 1px solid; padding: 2px; background-color: rgba(255,255,153,0.8)">

    <p><b>Change these:</b></p>

    <blockquote>

      <p>Pick your Breakout Room:
        <select name="motor_num" id="motor_num" onchange="return update_motor_num(this);">
          <option value="01" selected>01</option>
          <option value="02">02</option>
          <option value="03">03</option>
          <option value="04">04</option>
          <option value="05">05</option>
          <option value="06">06</option>
        </select>
      </p>

      <p>Pick your Motor Port:
        <select name="motor_port" id="motor_port">
          <option value="A" selected>A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
          <option value="F">F</option>
        </select>
      </p>

    </blockquote>
  </div>

  <p><b>These will update automatically:</b></p>

  <div type="airtable-check" compare="changes" action="run-js">
    <input type=text id="name_val" value="motor01">
    <input type=text id="action_val" value="SPIKE_move_motor">
  </div>

  <p>Motor Speed from Airtable: <input type=text value="X" id="motor_speed_from_airtable" size="4"></p>

   <p>[ <a href="" onclick="return refresh_embedded_airtable();">refresh airtable data</a> ]</p>
   <!-- AIRTABLE EMBED: copy "Share view" code, change size to width="600" height="400" -->
   <iframe class="airtable-embed" src="https://airtable.com/embed/shrH7MPbySnPnn6qx?backgroundColor=cyan&viewControls=on" frameborder="0" onmousewheel="" width="600" height="500" style="background: transparent; border: 1px solid #ccc;"></iframe>

   <hr>

   <p>Experimental demo created by:</p>

   <p>
     <a href="http://ceeo.tufts.edu" target=_blank><img src="TuftsCEEO.png"></a>
     <br><br>
     For more information, please visit: <a href="http://ceeo.tufts.edu" target=_blank>http://ceeo.tufts.edu</a>
   </p>

   <p>For other experimental projects from Tufts CEEO: <a href="http://ceeoinnovations.org" target=_blank>CEEO Innovations</a></p>

</body>
</html>
